generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Auth & RBAC
// ============================================

model User {
  id            String    @id @default(cuid())
  username      String    @unique
  displayName   String?   @map("display_name")
  email         String?   @unique
  passwordHash  String?   @map("password_hash")
  role          Role      @default(VIEWER)
  department    String?
  isActive      Boolean   @default(true) @map("is_active")
  lastLoginAt   DateTime? @map("last_login_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  sessions        Session[]
  accounts        Account[]
  changeRequests  ChangeRequest[]   @relation("requestor")
  assignedRequests ChangeRequest[]  @relation("assignee")
  approvals       Approval[]
  comments        Comment[]
  auditLogs       AuditLog[]
  notifications   Notification[]

  @@map("users")
}

enum Role {
  ADMIN
  MDM_MANAGER
  MDM_ANALYST
  REQUESTOR
  VIEWER
  SYSTEM
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================
// MDM Core - Change Requests (enriched)
// ============================================

model ChangeRequest {
  id              String            @id @default(cuid())
  requestNumber   String            @unique @map("request_number")
  title           String
  description     String?

  // ── MDM Classification ──
  category        ChangeCategory
  changeType      String?           @map("change_type")      // SharePoint request type (BOM Updates, Status Change Requests, etc.)
  mdmField        String?           @map("mdm_field")        // Specific field: item_status, buyer_code, pallet_config, bom, moq, lead_time, vendor, sourcing_rule, formula, upc_code, rounding_mult, foq, misc, other
  fieldLabel      String?           @map("field_label")      // Human label: "Status Change", "MOQ Update", etc.

  priority        Priority          @default(MEDIUM)
  status          RequestStatus     @default(NEW)
  risk            String?                                     // Low, Medium, High

  // ── Item & Change Details ──
  itemCode        String?           @map("item_code")
  itemCodes       String[]          @map("item_codes")       // Multiple items
  oldValue        String?           @map("old_value")
  newValue        String?           @map("new_value")

  // ── Target Systems & Orgs ──
  targetSystems   String[]          @map("target_systems")   // PLM, EBS
  orgs            String[]                                    // AND, DDR, WOD, PHL, IVC, IVCN

  // ── Source tracking ──
  source          String            @default("manual")        // manual, sharepoint, api, import
  sourceRef       String?           @map("source_ref")        // Original SP request ID
  sourceStatus    String?           @map("source_status")     // SharePoint status (In Progress, Not Started, etc.)
  rawContent      String?           @map("raw_content")
  parsedData      Json?             @map("parsed_data")

  // ── People ──
  requestorId     String?           @map("requestor_id")
  assignedToId    String?           @map("assigned_to_id")
  requestorName   String?           @map("requestor_name")
  assignedToName  String?           @map("assigned_to_name")  // For external assignees not in user table

  // ── Dates ──
  dateRequested   DateTime?         @map("date_requested")    // Original request date from SharePoint
  dueDate         DateTime?         @map("due_date")
  completedAt     DateTime?         @map("completed_at")
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  // Relations
  requestor       User?             @relation("requestor", fields: [requestorId], references: [id])
  assignedTo      User?             @relation("assignee", fields: [assignedToId], references: [id])
  approvals       Approval[]
  comments        Comment[]
  attachments     Attachment[]
  auditLogs       AuditLog[]

  @@index([status])
  @@index([category])
  @@index([mdmField])
  @@index([requestorId])
  @@index([assignedToId])
  @@index([createdAt])
  @@index([itemCode])
  @@map("change_requests")
}

enum ChangeCategory {
  ITEM_MASTER
  BOM
  ROUTING
  VENDOR
  CUSTOMER
  PRICE
  WAREHOUSE
  SYSTEM_CONFIG
  OTHER
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum RequestStatus {
  NEW
  PENDING_REVIEW
  IN_PROGRESS
  PENDING_APPROVAL
  APPROVED
  REJECTED
  COMPLETED
  CANCELLED
}

// ============================================
// Approval Workflow
// ============================================

model Approval {
  id              String          @id @default(cuid())
  changeRequestId String          @map("change_request_id")
  approverId      String          @map("approver_id")
  step            Int             @default(1)
  status          ApprovalStatus  @default(PENDING)
  comment         String?
  decidedAt       DateTime?       @map("decided_at")
  createdAt       DateTime        @default(now()) @map("created_at")

  changeRequest   ChangeRequest   @relation(fields: [changeRequestId], references: [id], onDelete: Cascade)
  approver        User            @relation(fields: [approverId], references: [id])

  @@index([changeRequestId])
  @@map("approvals")
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  SKIPPED
}

// ============================================
// Comments & Attachments
// ============================================

model Comment {
  id              String        @id @default(cuid())
  changeRequestId String        @map("change_request_id")
  authorId        String        @map("author_id")
  content         String
  isInternal      Boolean       @default(false) @map("is_internal")
  createdAt       DateTime      @default(now()) @map("created_at")

  changeRequest   ChangeRequest @relation(fields: [changeRequestId], references: [id], onDelete: Cascade)
  author          User          @relation(fields: [authorId], references: [id])

  @@index([changeRequestId])
  @@map("comments")
}

model Attachment {
  id              String        @id @default(cuid())
  changeRequestId String        @map("change_request_id")
  filename        String
  mimeType        String        @map("mime_type")
  size            Int
  path            String
  createdAt       DateTime      @default(now()) @map("created_at")

  changeRequest   ChangeRequest @relation(fields: [changeRequestId], references: [id], onDelete: Cascade)

  @@map("attachments")
}

// ============================================
// System Configuration
// ============================================

model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  type        String   @default("string")  // string, number, boolean, json
  group       String   @default("general") // general, notification, workflow, integration, security
  label       String?
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([group])
  @@map("system_configs")
}

// ============================================
// Scheduled Jobs
// ============================================

model ScheduledJob {
  id          String    @id @default(cuid())
  name        String
  description String?
  cronExpr    String    @map("cron_expr")   // cron expression
  handler     String                         // handler identifier
  config      Json?                          // handler-specific config
  enabled     Boolean   @default(true)
  lastRunAt   DateTime? @map("last_run_at")
  lastStatus  String?   @map("last_status") // success, failed, running
  lastError   String?   @map("last_error")
  nextRunAt   DateTime? @map("next_run_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  runs        JobRun[]

  @@map("scheduled_jobs")
}

model JobRun {
  id          String   @id @default(cuid())
  jobId       String   @map("job_id")
  status      String                       // success, failed, running
  startedAt   DateTime @default(now()) @map("started_at")
  finishedAt  DateTime? @map("finished_at")
  duration    Int?                          // milliseconds
  output      String?
  error       String?

  job         ScheduledJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([startedAt])
  @@map("job_runs")
}

// ============================================
// Notifications
// ============================================

model Notification {
  id              String            @id @default(cuid())
  userId          String            @map("user_id")
  type            NotificationType
  title           String
  message         String
  link            String?                              // e.g. /dashboard/requests/xxx
  isRead          Boolean           @default(false) @map("is_read")
  createdAt       DateTime          @default(now()) @map("created_at")

  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  STATUS_CHANGE
  APPROVAL_REQUEST
  APPROVAL_RESULT
  COMMENT
  ASSIGNMENT
  SYSTEM
}

// ============================================
// Audit Log
// ============================================

model AuditLog {
  id              String        @id @default(cuid())
  entityType      String        @map("entity_type")
  entityId        String        @map("entity_id")
  action          String
  changes         Json?
  userId          String?       @map("user_id")
  ipAddress       String?       @map("ip_address")
  createdAt       DateTime      @default(now()) @map("created_at")

  user            User?         @relation(fields: [userId], references: [id])
  changeRequest   ChangeRequest? @relation(fields: [entityId], references: [id])

  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}
