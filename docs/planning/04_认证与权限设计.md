# 04 认证与权限设计

## 认证方式

### 1. 本地账号 (Credentials Provider)
- 用户名/密码登录
- bcrypt 密码哈希
- 密码策略: 最少8位，含大小写+数字

### 2. IWMS SSO
- POST `https://iwmsprd.corp.ivcinc.com:8010/auth` 验证
- 首次SSO登录自动创建本地用户记录
- SSO用户无本地密码

### 3. API Key (外部集成)
- Ingest API 等机器对机器调用
- Key存储在 `system_configs` 表

## RBAC 权限模型

### 默认角色

| 角色 | 说明 | 核心权限 |
|---|---|---|
| **admin** | 系统管理员 | 全部权限 |
| **mdm_manager** | MDM经理 | 变更请求全管理+审批+报表+数据标准管理 |
| **mdm_analyst** | MDM分析员 | 变更请求CRUD+处理+提交 |
| **approver** | 审批人 | 查看+审批 |
| **viewer** | 只读用户 | 查看列表/详情/报表 |
| **api_service** | API服务账号 | Ingest + 查询 |

### 权限矩阵

| 资源 | 操作 | admin | manager | analyst | approver | viewer |
|---|---|---|---|---|---|---|
| change_request | create | ✅ | ✅ | ✅ | ❌ | ❌ |
| change_request | read | ✅ | ✅ | ✅ | ✅ | ✅ |
| change_request | update | ✅ | ✅ | ✅* | ❌ | ❌ |
| change_request | delete | ✅ | ✅ | ❌ | ❌ | ❌ |
| change_request | approve | ✅ | ✅ | ❌ | ✅ | ❌ |
| change_request | export | ✅ | ✅ | ✅ | ✅ | ✅ |
| data_standard | manage | ✅ | ✅ | ❌ | ❌ | ❌ |
| data_quality | manage | ✅ | ✅ | ✅ | ❌ | ❌ |
| user | manage | ✅ | ❌ | ❌ | ❌ | ❌ |
| role | manage | ✅ | ❌ | ❌ | ❌ | ❌ |
| system_config | manage | ✅ | ❌ | ❌ | ❌ | ❌ |
| audit_log | read | ✅ | ✅ | ❌ | ❌ | ❌ |
| report | read | ✅ | ✅ | ✅ | ✅ | ✅ |
| integration | manage | ✅ | ❌ | ❌ | ❌ | ❌ |

*analyst 只能修改自己创建的或分配给自己的

### CASL 权限实现

```typescript
// src/lib/permissions.ts
import { AbilityBuilder, createMongoAbility } from '@casl/ability';

export function defineAbilityFor(user: User & { roles: Role[] }) {
  const { can, cannot, build } = new AbilityBuilder(createMongoAbility);
  
  const roleNames = user.roles.map(r => r.name);

  if (roleNames.includes('admin')) {
    can('manage', 'all');
    return build();
  }

  // 所有登录用户
  can('read', 'ChangeRequest');
  can('read', 'Report');
  can('read', 'Notification', { userId: user.id });

  if (roleNames.includes('mdm_manager')) {
    can('manage', 'ChangeRequest');
    can('approve', 'ChangeRequest');
    can('manage', 'DataStandard');
    can('manage', 'DataQualityRule');
    can('read', 'AuditLog');
    can('export', 'ChangeRequest');
  }

  if (roleNames.includes('mdm_analyst')) {
    can('create', 'ChangeRequest');
    can('update', 'ChangeRequest', { requestorId: user.id });
    can('update', 'ChangeRequest', { assignedToId: user.id });
    can('manage', 'DataQualityRule');
    can('export', 'ChangeRequest');
  }

  if (roleNames.includes('approver')) {
    can('approve', 'ChangeRequest');
    can('export', 'ChangeRequest');
  }

  return build();
}
```

## Session 管理

- NextAuth.js JWT strategy (无状态)
- Token有效期: 8小时 (工作日)
- Refresh: sliding window
- 并发登录: 允许多设备
