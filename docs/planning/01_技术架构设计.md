# 01 技术架构设计

## 技术选型明细

### 前端
| 技术 | 版本 | 用途 |
|---|---|---|
| Next.js | 16.1.6 | 全栈框架 (App Router + Turbopack) |
| React | 19.x | UI库 |
| TypeScript | 5.x | 类型安全 |
| Tailwind CSS | 4.x | 样式系统 |
| shadcn/ui | latest | 组件库 (基于Radix UI) |
| TanStack Table | 8.x | 高级数据表格 (排序/过滤/分页/列调整) |
| TanStack Query | 5.x | 服务端状态管理/缓存 |
| React Hook Form + Zod | latest | 表单+验证 |
| Zustand | 5.x | 客户端状态管理 |
| Recharts / Tremor | latest | 图表/仪表板 |
| nuqs | latest | URL状态管理(搜索参数) |
| next-intl | latest | 国际化 (中/英) |

### 后端
| 技术 | 用途 |
|---|---|
| Next.js Route Handlers | API端点 |
| Prisma | ORM + Migration |
| Zod | Schema验证 |
| NextAuth.js (Auth.js v5) | 认证框架 |
| CASL | 细粒度权限控制 |
| BullMQ + Redis | 后台任务队列 |
| Nodemailer | 邮件通知 |
| Winston / Pino | 日志 |
| Sharp | 图片处理 |

### 数据库 & 中间件
| 技术 | 用途 |
|---|---|
| PostgreSQL 16 | 主数据库 |
| Redis 7 | 缓存/Session/队列 |
| MinIO (可选) | 文件存储 |

### DevOps
| 技术 | 用途 |
|---|---|
| Docker + Docker Compose | 容器化 |
| GitHub Actions | CI/CD |
| ESLint + Prettier | 代码规范 |
| Vitest + Playwright | 测试 |
| Sentry (可选) | 错误追踪 |

---

## 项目目录结构

```
openassist/
├── .env.local                    # 本地环境变量
├── .env.example                  # 环境变量模板
├── docker-compose.yml            # 开发环境容器编排
├── docker-compose.prod.yml       # 生产环境
├── Dockerfile                    # 应用镜像
├── next.config.ts
├── tailwind.config.ts
├── tsconfig.json
├── prisma/
│   ├── schema.prisma             # 数据模型定义
│   ├── migrations/               # 数据库迁移文件
│   └── seed.ts                   # 种子数据
├── src/
│   ├── app/                      # Next.js App Router
│   │   ├── (auth)/               # 认证相关页面
│   │   │   ├── login/
│   │   │   └── layout.tsx
│   │   ├── (dashboard)/          # 主应用(需登录)
│   │   │   ├── layout.tsx        # 侧边栏+顶栏布局
│   │   │   ├── page.tsx          # Dashboard首页
│   │   │   ├── change-requests/  # 变更请求管理
│   │   │   │   ├── page.tsx      # 列表页
│   │   │   │   ├── [id]/page.tsx # 详情页
│   │   │   │   └── new/page.tsx  # 新建
│   │   │   ├── approvals/        # 审批中心
│   │   │   ├── data-standards/   # 数据标准管理
│   │   │   ├── data-quality/     # 数据质量
│   │   │   ├── integrations/     # 系统集成配置
│   │   │   ├── reports/          # 报表分析
│   │   │   ├── admin/            # 系统管理
│   │   │   │   ├── users/
│   │   │   │   ├── roles/
│   │   │   │   ├── system-config/
│   │   │   │   ├── audit-logs/
│   │   │   │   └── jobs/
│   │   │   └── settings/         # 个人设置
│   │   ├── api/                  # API Route Handlers
│   │   │   ├── auth/[...nextauth]/
│   │   │   ├── change-requests/
│   │   │   ├── approvals/
│   │   │   ├── admin/
│   │   │   ├── ingest/
│   │   │   └── webhooks/
│   │   ├── layout.tsx            # Root Layout
│   │   └── globals.css
│   ├── components/               # 共享组件
│   │   ├── ui/                   # shadcn/ui 组件
│   │   ├── layout/               # 布局组件(Sidebar/Header/Breadcrumb)
│   │   ├── forms/                # 业务表单组件
│   │   ├── tables/               # 数据表格组件
│   │   └── charts/               # 图表组件
│   ├── lib/                      # 工具库
│   │   ├── db.ts                 # Prisma Client
│   │   ├── auth.ts               # Auth配置
│   │   ├── permissions.ts        # CASL权限定义
│   │   ├── validators/           # Zod schemas
│   │   ├── utils.ts              # 通用工具
│   │   └── constants.ts          # 常量
│   ├── services/                 # 业务逻辑层
│   │   ├── change-request.ts
│   │   ├── approval.ts
│   │   ├── notification.ts
│   │   ├── audit.ts
│   │   ├── parser.ts             # Smart Parser (迁移)
│   │   ├── data-quality.ts
│   │   └── integration/          # 外部系统集成
│   │       ├── ebs.ts
│   │       ├── wms.ts
│   │       └── sharepoint.ts
│   ├── hooks/                    # React Hooks
│   ├── types/                    # TypeScript类型定义
│   └── config/                   # 应用配置
├── public/
├── tests/
│   ├── unit/
│   ├── integration/
│   └── e2e/
├── scripts/
│   ├── migrate-json.ts           # JSON→PG迁移脚本
│   └── setup.ts                  # 初始化脚本
└── docs/                         # 项目文档
```

---

## 环境变量定义

```env
# .env.example

# ─── 应用 ───
NODE_ENV=development
NEXT_PUBLIC_APP_NAME=OpenAssist
NEXT_PUBLIC_APP_URL=http://localhost:3000

# ─── 数据库 ───
DATABASE_URL=postgresql://openassist:password@localhost:5432/openassist_dev
DIRECT_URL=postgresql://openassist:password@localhost:5432/openassist_dev

# ─── Redis ───
REDIS_URL=redis://localhost:6379

# ─── 认证 ───
NEXTAUTH_SECRET=<生成的随机密钥>
NEXTAUTH_URL=http://localhost:3000

# IWMS SSO
IWMS_AUTH_URL=https://iwmsprd.corp.ivcinc.com:8010/auth
IWMS_SSO_ENABLED=true

# ─── 外部系统 ───
# Oracle EBS (只读)
EBS_PRD_CONNECTION=prd1ivcdb01.corp.ivcinc.com:1531/PRD1IVC
EBS_PRD_USER=Xxapps_ro
EBS_PRD_PASSWORD=<密码>

# SharePoint
SHAREPOINT_MDM_URL=https://ivcinc.sharepoint.com/sites/CS/Lists/Master%20Data%20Requests/
SHAREPOINT_CLIENT_ID=<client_id>
SHAREPOINT_CLIENT_SECRET=<client_secret>

# ─── 邮件 ───
SMTP_HOST=smtp.corp.ivcinc.com
SMTP_PORT=587
SMTP_USER=
SMTP_PASS=
MAIL_FROM=openassist@ivcinc.com

# ─── Ingest API ───
INGEST_API_KEY=openassist-ingest-2026

# ─── 日志 ───
LOG_LEVEL=debug
```

---

## Docker Compose (开发环境)

```yaml
# docker-compose.yml
version: '3.8'

services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: openassist_dev
      POSTGRES_USER: openassist
      POSTGRES_PASSWORD: password
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redisdata:/data

  # 可选: pgAdmin
  pgadmin:
    image: dpage/pgadmin4
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@local.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "5050:80"

volumes:
  pgdata:
  redisdata:
```

---

## 关键架构决策

### 1. 为什么 Prisma 而非 Drizzle/TypeORM
- **Prisma:** Schema-first、自动迁移、类型安全、Studio可视化、文档完善
- 企业项目优先稳定性和可维护性

### 2. 为什么 PostgreSQL 而非 MySQL/SQLite
- JSON/JSONB 原生支持（变更请求的动态字段）
- 全文搜索内置 (tsvector)
- 数组类型、CTE、窗口函数
- 企业级可靠性

### 3. Server Components vs Client Components 策略
- **Server Components (默认):** 列表页、详情页、Dashboard — 减少JS bundle
- **Client Components:** 交互式表单、实时搜索、图表 — 需要浏览器API的场景
- **Server Actions:** 表单提交、数据变更 — 简化API层

### 4. 认证策略
- 内部用户: 本地账号 (NextAuth Credentials)
- 企业用户: IWMS SSO 集成 (Custom Provider)
- API调用: API Key (Ingest等)
- 未来: LDAP/AD 集成
