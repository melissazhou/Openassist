# 13 OpenAssist v1.1 — 缺陷分析与开发计划

> 分析时间: 2026-02-27
> 基线: v1.0 Feature Complete (Phase 1-5 + Sprint 1-4 + 技术债)

---

## 一、代码审计发现

### 🔴 安全缺陷

| # | 问题 | 文件 | 严重度 | 说明 |
|---|------|------|--------|------|
| S1 | **API缺少try-catch** | admin/config, admin/jobs, stats, notifications, users, approvals/pending, audit (7个) | 高 | 未处理的异常直接返回500+堆栈信息，生产环境信息泄漏 |
| S2 | **用户列表无权限限制** | `users/route.ts` GET | 中 | 任何登录用户可查看全部用户列表（含email/部门），应限ADMIN |
| S3 | **config PUT缺少Zod验证** | `admin/config/route.ts` | 中 | 只检查`Array.isArray`，未验证key/value格式 |
| S4 | **ingest API无速率限制** | `mdm/ingest/route.ts` | 中 | API Key认证但无限流，可被暴力攻击 |
| S5 | **登录页错误信息始终可见** | `login/page.tsx` | 低 | error state初始化为""但渲染逻辑`{error && ...}`首次不触发，但刷新后可能残留 |
| S6 | **附件上传缺少类型/大小校验** | `requests/[id]/attachments/route.ts` | 中 | 未限制文件类型和大小，可上传任意文件 |
| S7 | **Session user.role类型断言** | 多个API文件 | 低 | `(session.user as any).role` 不安全，应扩展NextAuth types |

### 🟡 功能缺陷

| # | 问题 | 说明 |
|---|------|------|
| F1 | **Dashboard KPI无Dark Mode适配** | Status badges使用硬编码light颜色，Dark Mode下可读性差 |
| F2 | **看板(Kanban)缺少拖拽** | 只有按钮式状态变更，无drag-and-drop体验 |
| F3 | **Analytics图表无Dark Mode** | Recharts颜色硬编码，Dark Mode下坐标轴/tooltip不适配 |
| F4 | **通知偏好只存client state** | Settings页的通知开关重启后丢失，未持久化 |
| F5 | **评论不支持编辑/删除** | 发布后无法修改或删除评论 |
| F6 | **搜索无防抖** | requests列表搜索每次输入都触发API请求 |
| F7 | **批量操作无确认** | 批量设置状态无二次确认（删除有确认） |
| F8 | **导入模板缺少下载** | Template按钮`window.open("/api/requests/import")` 实际是GET请求，应返回CSV模板 |
| F9 | **密码修改后不登出** | 密码修改成功后session仍有效，应强制重新登录 |
| F10 | **Kanban无分页/上限** | 加载全部请求到看板，数据量大时性能问题 |

### 🟢 代码质量

| # | 问题 | 说明 |
|---|------|------|
| Q1 | **Prisma import不一致** | 部分文件 `import prisma from` vs `import { prisma } from`，seed.ts用`new PrismaClient()` |
| Q2 | **无TypeScript strict检查** | `tsconfig.json` 可能未开启strict |
| Q3 | **无ESLint规则配置** | 默认eslint配置，无自定义规则 |
| Q4 | **测试覆盖率 0%** | 无单元测试、集成测试、E2E测试 |
| Q5 | **API路由无统一错误处理** | 每个route.ts各自catch，缺少统一的error handler |
| Q6 | **select元素未用shadcn/ui** | 创建请求表单用原生`<select>`而非`<Select>`组件 |

---

## 二、缺失功能分析

### 遗留自 v1.0 规划 (P2级)

| # | 功能 | 原始编号 | 工作量 |
|---|------|---------|--------|
| P1 | **SLA预警** | G15 | 1天 |
| P2 | **PDF导出** | G18 | 1天 |
| P3 | **收藏/关注** | G16 | 0.5天 |
| P4 | **保存筛选视图** | G7 | 1天 |
| P5 | **Dashboard Widget可配置** | G10 | 1.5天 |
| P6 | **评论@提及** | G11 | 1天 |
| P7 | **WebSocket实时更新** | G20 | 2天 |

### 企业级需求 (新增)

| # | 功能 | 说明 | 工作量 |
|---|------|------|--------|
| E1 | **RBAC细化** | 字段级权限控制，不同角色可见不同字段 | 2天 |
| E2 | **操作确认流程** | 危险操作(删除/批量)增加二次确认+密码验证 | 0.5天 |
| E3 | **数据导出审计** | 导出操作记录审计日志 | 0.5天 |
| E4 | **Session超时管理** | 可配置会话超时时间+自动登出 | 1天 |
| E5 | **API速率限制** | 基于IP/用户的请求频率限制 | 1天 |
| E6 | **附件预览** | 图片/PDF在线预览（不用下载） | 1天 |

---

## 三、开发计划

### Phase 6: 安全加固 + 代码质量 (3天)

**Sprint 5: 安全修复 (1-2天)**

| 序号 | 任务 | 优先级 |
|------|------|--------|
| 1 | API全局try-catch + 统一错误响应格式 | P0 |
| 2 | 用户列表API增加ADMIN权限检查（或限制返回字段） | P0 |
| 3 | config API接入configUpdateSchema验证 | P0 |
| 4 | 附件上传增加文件类型白名单+大小限制(10MB) | P0 |
| 5 | NextAuth types扩展(消除`as any`) | P1 |
| 6 | Prisma import统一化 | P1 |

**Sprint 6: UX修复 (1天)**

| 序号 | 任务 | 优先级 |
|------|------|--------|
| 1 | Dashboard + Kanban + Analytics Dark Mode适配 | P0 |
| 2 | 搜索防抖(300ms debounce) | P1 |
| 3 | 批量状态变更增加确认对话框 | P1 |
| 4 | 表单select替换为shadcn/ui Select | P1 |
| 5 | 导入模板GET返回CSV模板文件 | P1 |
| 6 | 通知偏好持久化到数据库(user字段或SystemConfig) | P2 |

### Phase 7: 功能增强 (5天)

**Sprint 7: 业务功能 (2-3天)**

| 序号 | 任务 | 说明 |
|------|------|------|
| 1 | SLA预警系统 | 基于dueDate计算SLA，超期自动标红+通知 |
| 2 | 保存筛选视图 | 用户可保存常用筛选条件，一键加载 |
| 3 | 评论编辑/删除 | 作者可编辑/删除自己的评论 |
| 4 | 收藏/关注请求 | 关注后变更自动通知 |

**Sprint 8: 集成增强 (2天)**

| 序号 | 任务 | 说明 |
|------|------|------|
| 1 | PDF导出 | 单条请求导出为PDF报告（含详情/评论/审批历史） |
| 2 | 附件预览 | 图片/PDF在线预览 |
| 3 | 导出审计 | 导出操作记录审计日志 |

### Phase 8: 测试与生产准备 (3-5天)

**Sprint 9: 测试 (2-3天)**

| 序号 | 任务 | 说明 |
|------|------|------|
| 1 | Vitest单元测试 | validators, notifications helper, 工具函数 |
| 2 | API集成测试 | 核心CRUD + 审批流程 + 权限验证 |
| 3 | Playwright E2E | 登录→创建→审批→完成 完整流程 |

**Sprint 10: 生产准备 (1-2天)**

| 序号 | 任务 | 说明 |
|------|------|------|
| 1 | Docker Compose | 一键启动(Next.js + PostgreSQL + Redis) |
| 2 | CI/CD Pipeline | GitHub Actions: lint + test + build |
| 3 | 健康检查端点优化 | 增加响应时间、连接池状态 |
| 4 | 日志结构化 | pino/winston替代console.log |
| 5 | 环境变量校验 | 启动时检查必须的环境变量 |

---

## 四、推荐优先级

```
立即修复 (Sprint 5-6, 本周):
  → 安全缺陷 S1-S6
  → Dark Mode适配 F1/F3
  → 搜索防抖 F6
  → Prisma import统一

下一阶段 (Sprint 7-8, 下周):
  → SLA预警
  → 评论编辑/删除
  → PDF导出
  → 保存筛选视图

生产前 (Sprint 9-10):
  → 测试覆盖
  → Docker Compose
  → 日志 + 监控

暂缓:
  → WebSocket实时更新 (当前30s轮询够用)
  → Dashboard Widget可配置 (低频需求)
  → 评论@提及 (低优先级)
  → RBAC细化 (当前角色模型够用)
```

---

## 五、技术债追踪

| 项目 | 状态 | 说明 |
|------|------|------|
| ~~middleware→proxy~~ | ✅ 已完成 | Sprint 4 技术债 |
| ~~Zod验证补全~~ | ✅ 已完成 | 6个schema |
| ~~Error Boundary~~ | ✅ 已完成 | error.tsx + not-found.tsx |
| API try-catch | ⏳ 待修复 | 7个API无错误处理 |
| Prisma import一致性 | ⏳ 待修复 | default vs named export |
| TypeScript strict | ⏳ 待评估 | 可能引入大量类型错误 |
| 测试覆盖率 | ⏳ 0% | 目标: 核心流程60%+ |
| ESLint规则 | ⏳ 默认配置 | 需要自定义规则 |
