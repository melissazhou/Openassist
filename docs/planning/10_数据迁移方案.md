# 10 数据迁移方案

## 迁移范围

| 数据源 | 记录数 | 目标表 |
|---|---|---|
| `change_requests.json` | 3102条 (63 active, 3039 completed) | change_requests + cr_items |
| 硬编码用户 (4个) | 4 | users + user_roles |

## 迁移脚本

```typescript
// scripts/migrate-json.ts

import { readFileSync } from 'fs';
import { PrismaClient } from '@prisma/client';
import { hash } from 'bcryptjs';

const prisma = new PrismaClient();

async function main() {
  // 1. 创建用户
  const users = [
    { username: 'admin', displayName: 'Administrator', role: 'admin' },
    { username: 'mdm', displayName: 'MDM Analyst', role: 'mdm_analyst' },
    { username: 'demo', displayName: 'Demo User', role: 'viewer' },
    { username: 'viewer', displayName: 'Viewer', role: 'viewer' },
  ];
  
  for (const u of users) {
    await prisma.user.create({
      data: {
        username: u.username,
        displayName: u.displayName,
        passwordHash: await hash(u.username === 'admin' ? 'admin123' : u.username, 10),
        authProvider: 'LOCAL',
      }
    });
  }

  // 2. 读取JSON
  const raw = JSON.parse(readFileSync('app/data/change_requests.json', 'utf-8'));
  
  // 3. 生成请求编号
  let counter = 1;
  
  for (const item of raw) {
    const requestNumber = `CR-${new Date(item.date || item.requested_date).getFullYear()}-${String(counter++).padStart(5, '0')}`;
    
    // 4. 映射状态
    const status = mapStatus(item.status);
    
    // 5. 映射类别
    const category = mapCategory(item.category);
    
    // 6. 查找/创建用户
    const requestor = await findOrCreateUser(item.requestor);
    const assignedTo = item.assigned_to ? await findOrCreateUser(item.assigned_to) : null;
    
    // 7. 创建记录
    await prisma.changeRequest.create({
      data: {
        requestNumber,
        title: item.title,
        description: item.description || null,
        category,
        status,
        source: 'SHAREPOINT',
        sourceRef: item.sharepoint_id || null,
        requestorId: requestor.id,
        assignedToId: assignedTo?.id,
        requestedDate: new Date(item.date || item.requested_date),
        completedDate: status === 'COMPLETED' ? new Date(item.completed_date || item.date) : null,
        changes: item.parsed_data || null,
        targetSystems: item.target_systems || [],
        // 解析的字段变更 → CRItem
        items: item.parsed_data?.changes ? {
          create: item.parsed_data.changes.map((c: any) => ({
            fieldName: c.field || 'unknown',
            oldValue: c.old_value,
            newValue: c.new_value,
            targetSystem: c.target_system,
          }))
        } : undefined,
      }
    });
  }
  
  console.log(`Migrated ${counter - 1} change requests`);
}

function mapStatus(s: string): string {
  const map: Record<string, string> = {
    'active': 'SUBMITTED',
    'completed': 'COMPLETED',
    'pending': 'PENDING_REVIEW',
    'rejected': 'REJECTED',
    'cancelled': 'CANCELLED',
  };
  return map[s?.toLowerCase()] || 'SUBMITTED';
}

function mapCategory(c: string): string {
  const map: Record<string, string> = {
    'item_master': 'ITEM_MASTER',
    'bom': 'BOM',
    'routing': 'ROUTING',
    'vendor': 'VENDOR',
    'customer': 'CUSTOMER',
    'pricing': 'PRICING',
    'uom': 'UOM',
    'category_code': 'CATEGORY_CODE',
  };
  return map[c?.toLowerCase()] || 'OTHER';
}
```

## 迁移步骤

1. **备份原文件:** `copy change_requests.json change_requests.json.bak`
2. **创建数据库:** `docker-compose up -d postgres`
3. **运行迁移:** `npx prisma migrate deploy`
4. **种子数据:** `npx prisma db seed` (角色/权限/配置)
5. **数据迁移:** `npx tsx scripts/migrate-json.ts`
6. **验证:**
   - 总记录数 = 3102
   - active记录数 = 63 (status=SUBMITTED)
   - completed记录数 = 3039
   - 所有用户已创建
7. **回退方案:** 删除PG数据, 切回Flask+JSON版本
