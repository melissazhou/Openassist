# 05 审批工作流设计

## 工作流状态机

```
DRAFT → SUBMITTED → PENDING_REVIEW → PENDING_APPROVAL → APPROVED → IN_PROGRESS → COMPLETED
                  ↘                ↙       ↘           ↙
                    ←── RETURNED ──←        REJECTED
                         ↓
                      CANCELLED
```

## 默认工作流模板

### 标准变更流程 (大部分Category)
1. **提交** — Requestor 提交
2. **MDM分析员审核** — 检查数据完整性/合规性
3. **MDM经理审批** — 业务审批
4. **执行** — 同步到目标系统
5. **关闭** — 确认完成

### 紧急变更流程
1. **提交** — 标记CRITICAL优先级
2. **MDM经理审批** — 跳过分析员审核
3. **执行**
4. **补审核** — 事后审核记录

### 批量变更流程
1. **提交** — 附带变更清单Excel
2. **MDM分析员抽查** — 抽样检查
3. **MDM经理审批**
4. **批量执行** — 逐条同步+异常处理
5. **关闭**

## 工作流引擎逻辑

```typescript
// src/services/workflow.ts

interface WorkflowEngine {
  // 启动工作流
  start(crId: string, templateId?: string): Promise<void>;
  
  // 推进到下一步
  advance(crId: string, decision: Decision): Promise<void>;
  
  // 退回到上一步
  returnStep(crId: string, targetStep: number, comments: string): Promise<void>;
  
  // 检查超时
  checkTimeouts(): Promise<void>;    // cron调用
  
  // 委托审批
  delegate(approvalId: string, toUserId: string): Promise<void>;
}

// 自动路由: 根据 category 匹配工作流模板
// 如果无匹配模板, 使用标准流程
function resolveTemplate(category: CRCategory): WorkflowTemplate { ... }
```

## 审批规则

| 规则 | 说明 |
|---|---|
| 超时自动升级 | 审批超48小时未处理 → 通知上级 |
| 自动审批 | 低风险变更(如描述修改) → 规则匹配后自动通过 |
| 回退限制 | 最多回退2次，超过自动升级 |
| 委托 | 审批人可委托给同角色其他用户 |
| 会签 | 跨部门变更需多人全部通过 |

## 通知触发点

| 事件 | 通知对象 | 渠道 |
|---|---|---|
| 新请求提交 | 分配的分析员 | 站内信+邮件 |
| 待审批 | 审批人 | 站内信+邮件 |
| 审批通过/驳回 | Requestor | 站内信+邮件 |
| 审批超时 | 审批人+上级 | 邮件 |
| 同步完成 | Requestor+分析员 | 站内信 |
| 同步失败 | 分析员+管理员 | 站内信+邮件 |
