# 02 数据库设计

## Prisma Schema

```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ════════════════════════════════════
// 用户与权限
// ════════════════════════════════════

model User {
  id            String    @id @default(cuid())
  username      String    @unique
  email         String?   @unique
  displayName   String
  passwordHash  String?                // null = SSO用户
  authProvider  AuthProvider @default(LOCAL)
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  userRoles         UserRole[]
  changeRequests    ChangeRequest[]    @relation("Requestor")
  assignedRequests  ChangeRequest[]    @relation("AssignedTo")
  approvals         Approval[]
  comments          Comment[]
  notifications     Notification[]
  auditLogs         AuditLog[]

  @@map("users")
}

enum AuthProvider {
  LOCAL
  IWMS_SSO
  LDAP
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique      // admin, mdm_analyst, viewer, approver
  displayName String
  description String?
  isSystem    Boolean  @default(false)  // 系统角色不可删除
  createdAt   DateTime @default(now())

  userRoles   UserRole[]
  permissions RolePermission[]

  @@map("roles")
}

model Permission {
  id       String @id @default(cuid())
  resource String              // change_request, data_standard, user, ...
  action   String              // create, read, update, delete, approve, export
  
  roles    RolePermission[]

  @@unique([resource, action])
  @@map("permissions")
}

model UserRole {
  userId String
  roleId String
  user   User   @relation(fields: [userId], references: [id])
  role   Role   @relation(fields: [roleId], references: [id])

  @@id([userId, roleId])
  @@map("user_roles")
}

model RolePermission {
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id])
  permission   Permission @relation(fields: [permissionId], references: [id])

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

// ════════════════════════════════════
// 变更请求 (核心)
// ════════════════════════════════════

model ChangeRequest {
  id              String   @id @default(cuid())
  requestNumber   String   @unique          // CR-2026-00001 格式
  title           String
  description     String?
  
  // 分类
  category        CRCategory
  priority        Priority  @default(MEDIUM)
  
  // 状态
  status          CRStatus  @default(DRAFT)
  
  // 数据变更内容
  entityType      String?              // item, vendor, customer, bom...
  entityCode      String?              // 物料号/供应商号等
  changes         Json?                // { field: { old: x, new: y } }
  targetSystems   String[]             // ["EBS", "WMS", "MES"]
  
  // 来源
  source          String   @default("MANUAL")  // MANUAL, SHAREPOINT, API, EMAIL
  sourceRef       String?              // SharePoint ID等外部引用
  
  // 人员
  requestorId     String
  requestor       User     @relation("Requestor", fields: [requestorId], references: [id])
  assignedToId    String?
  assignedTo      User?    @relation("AssignedTo", fields: [assignedToId], references: [id])
  
  // 时间
  requestedDate   DateTime @default(now())
  dueDate         DateTime?
  completedDate   DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // 关联
  items           CRItem[]
  approvals       Approval[]
  comments        Comment[]
  attachments     Attachment[]
  syncLogs        SyncLog[]

  @@index([status])
  @@index([category])
  @@index([requestorId])
  @@index([assignedToId])
  @@index([requestedDate])
  @@index([source, sourceRef])
  @@map("change_requests")
}

enum CRCategory {
  ITEM_MASTER
  BOM
  ROUTING
  VENDOR
  CUSTOMER
  PRICING
  UOM
  CATEGORY_CODE
  OTHER
}

enum CRStatus {
  DRAFT
  SUBMITTED
  PENDING_REVIEW
  PENDING_APPROVAL
  APPROVED
  IN_PROGRESS
  COMPLETED
  REJECTED
  CANCELLED
  ON_HOLD
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model CRItem {
  id              String  @id @default(cuid())
  changeRequestId String
  changeRequest   ChangeRequest @relation(fields: [changeRequestId], references: [id], onDelete: Cascade)
  
  fieldName       String           // 变更字段名
  oldValue        String?          // 旧值
  newValue        String?          // 新值
  targetSystem    String?          // 目标系统
  notes           String?

  @@map("cr_items")
}

// ════════════════════════════════════
// 审批工作流
// ════════════════════════════════════

model WorkflowTemplate {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  category    CRCategory?          // 绑定到特定类别，null=通用
  isActive    Boolean  @default(true)
  steps       WorkflowStep[]
  createdAt   DateTime @default(now())

  @@map("workflow_templates")
}

model WorkflowStep {
  id         String   @id @default(cuid())
  templateId String
  template   WorkflowTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  
  stepOrder  Int
  name       String              // "MDM Analyst Review", "Manager Approval"
  type       ApprovalType
  approverRoleId String?         // 按角色审批
  approverUserId String?         // 指定人审批
  timeoutHours   Int?            // 超时小时数

  @@unique([templateId, stepOrder])
  @@map("workflow_steps")
}

enum ApprovalType {
  SINGLE       // 单人审批
  ALL          // 会签（全部通过）
  ANY          // 或签（任一通过）
  AUTO         // 自动审批（规则匹配）
}

model Approval {
  id              String   @id @default(cuid())
  changeRequestId String
  changeRequest   ChangeRequest @relation(fields: [changeRequestId], references: [id])
  
  stepName        String
  stepOrder       Int
  approverId      String
  approver        User     @relation(fields: [approverId], references: [id])
  
  status          ApprovalStatus @default(PENDING)
  decision        String?        // APPROVE, REJECT, RETURN
  comments        String?
  decidedAt       DateTime?
  dueAt           DateTime?
  createdAt       DateTime @default(now())

  @@index([changeRequestId, stepOrder])
  @@map("approvals")
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  RETURNED
  SKIPPED
  EXPIRED
}

// ════════════════════════════════════
// 评论 & 附件
// ════════════════════════════════════

model Comment {
  id              String   @id @default(cuid())
  changeRequestId String
  changeRequest   ChangeRequest @relation(fields: [changeRequestId], references: [id], onDelete: Cascade)
  authorId        String
  author          User     @relation(fields: [authorId], references: [id])
  content         String
  isInternal      Boolean  @default(false)  // 内部备注
  createdAt       DateTime @default(now())

  @@map("comments")
}

model Attachment {
  id              String   @id @default(cuid())
  changeRequestId String
  changeRequest   ChangeRequest @relation(fields: [changeRequestId], references: [id], onDelete: Cascade)
  fileName        String
  fileSize        Int
  mimeType        String
  storagePath     String
  uploadedBy      String
  createdAt       DateTime @default(now())

  @@map("attachments")
}

// ════════════════════════════════════
// 数据标准 & 数据质量
// ════════════════════════════════════

model DataStandard {
  id          String   @id @default(cuid())
  name        String   @unique
  category    String              // naming, coding, classification
  description String?
  rules       Json                // 规则定义JSON
  isActive    Boolean  @default(true)
  version     Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("data_standards")
}

model DataQualityRule {
  id          String   @id @default(cuid())
  name        String
  entityType  String              // item, vendor...
  fieldName   String
  ruleType    String              // required, format, range, lookup, custom
  ruleConfig  Json                // { pattern: "...", min: 0, lookupTable: "..." }
  severity    String   @default("ERROR")  // ERROR, WARNING, INFO
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  @@map("data_quality_rules")
}

model DataQualityResult {
  id          String   @id @default(cuid())
  ruleId      String
  entityType  String
  entityCode  String
  fieldName   String
  value       String?
  status      String              // PASS, FAIL, WARNING
  message     String?
  checkedAt   DateTime @default(now())

  @@index([entityType, entityCode])
  @@index([checkedAt])
  @@map("data_quality_results")
}

// ════════════════════════════════════
// 系统集成 & 同步
// ════════════════════════════════════

model IntegrationConfig {
  id           String  @id @default(cuid())
  systemName   String  @unique       // EBS, WMS, MES
  systemType   String                // oracle, api, file
  connectionConfig Json             // 加密存储连接信息
  isActive     Boolean @default(true)
  lastSyncAt   DateTime?

  syncLogs     SyncLog[]

  @@map("integration_configs")
}

model SyncLog {
  id              String   @id @default(cuid())
  changeRequestId String?
  changeRequest   ChangeRequest? @relation(fields: [changeRequestId], references: [id])
  integrationId   String
  integration     IntegrationConfig @relation(fields: [integrationId], references: [id])
  
  action          String              // CREATE, UPDATE, DELETE
  payload         Json?
  status          String              // SUCCESS, FAILED, PARTIAL
  errorMessage    String?
  syncedAt        DateTime @default(now())

  @@index([changeRequestId])
  @@index([syncedAt])
  @@map("sync_logs")
}

// ════════════════════════════════════
// 审计 & 通知
// ════════════════════════════════════

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  user       User?    @relation(fields: [userId], references: [id])
  action     String              // CREATE, UPDATE, DELETE, LOGIN, APPROVE...
  resource   String              // change_request, user, ...
  resourceId String?
  oldValues  Json?
  newValues  Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([resource, resourceId])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  type      String              // approval_request, cr_update, system
  title     String
  message   String
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId, isRead])
  @@map("notifications")
}

// ════════════════════════════════════
// 系统配置
// ════════════════════════════════════

model SystemConfig {
  key         String   @id
  value       Json
  description String?
  category    String   @default("general")
  updatedAt   DateTime @updatedAt

  @@map("system_configs")
}
```

---

## 数据迁移策略

### 从 JSON → PostgreSQL

1. **导出现有数据:** 读取 `change_requests.json` (3102条记录)
2. **字段映射:**
   - `id` → 保留或重新生成 cuid
   - `title` → `title` + 解析生成 `requestNumber`
   - `status`: active→SUBMITTED, completed→COMPLETED
   - `category` → 映射到 CRCategory enum
   - Smart Parser 已解析的字段 → `changes` JSON + `CRItem` 行
   - `requestor` / `assigned_to` → 创建对应 User 记录后关联
3. **验证:** 迁移后对比记录数、各状态统计
4. **回退:** 保留原JSON文件作为备份

### 种子数据

```typescript
// prisma/seed.ts
// 1. 创建默认角色: admin, mdm_analyst, approver, viewer
// 2. 创建初始管理员用户
// 3. 创建默认权限矩阵
// 4. 创建默认工作流模板
// 5. 创建示例数据标准
// 6. 导入系统配置默认值
```
