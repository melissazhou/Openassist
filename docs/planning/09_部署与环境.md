# 09 部署与环境管理

## 环境规划

| 环境 | URL | 数据库 | 用途 |
|---|---|---|---|
| DEV | localhost:3000 | Docker PG (本地) | 开发调试 |
| UAT | openassist-uat.corp.ivcinc.com | PG (服务器) | 用户验收 |
| PRD | openassist.corp.ivcinc.com | PG (服务器+备份) | 生产 |

## Docker化

### Dockerfile
```dockerfile
FROM node:22-alpine AS base

# 依赖层
FROM base AS deps
WORKDIR /app
COPY package.json pnpm-lock.yaml ./
RUN corepack enable pnpm && pnpm install --frozen-lockfile

# 构建层
FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .
RUN npx prisma generate
RUN pnpm build

# 运行层
FROM base AS runner
WORKDIR /app
ENV NODE_ENV=production
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs
COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static
COPY --from=builder /app/prisma ./prisma
USER nextjs
EXPOSE 3000
CMD ["node", "server.js"]
```

### docker-compose.prod.yml
```yaml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - DATABASE_URL=postgresql://openassist:${DB_PASSWORD}@postgres:5432/openassist
      - REDIS_URL=redis://redis:6379
    depends_on:
      - postgres
      - redis
    restart: unless-stopped

  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: openassist
      POSTGRES_USER: openassist
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./backups:/backups
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    restart: unless-stopped

  # 定时备份
  backup:
    image: postgres:16-alpine
    volumes:
      - ./backups:/backups
    entrypoint: /bin/sh
    command: >
      -c 'while true; do
        pg_dump -h postgres -U openassist openassist > /backups/openassist_$$(date +%Y%m%d_%H%M).sql;
        find /backups -name "*.sql" -mtime +30 -delete;
        sleep 86400;
      done'
    depends_on:
      - postgres

volumes:
  pgdata:
```

## CI/CD (GitHub Actions)

```yaml
# .github/workflows/deploy.yml
name: Deploy
on:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - run: pnpm install
      - run: pnpm lint
      - run: pnpm test

  deploy-uat:
    needs: test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to UAT
        run: |
          # SSH deploy or Docker registry push
          echo "Deploy to UAT server"

  deploy-prd:
    needs: deploy-uat
    environment: production    # 需要手动审批
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to PRD
        run: echo "Deploy to PRD server"
```

## 监控

- **健康检查:** `/api/health` (DB连接+Redis连接+磁盘空间)
- **日志:** Winston → 文件 + 控制台 (生产考虑 ELK)
- **错误追踪:** Sentry (可选)
- **性能:** Next.js Analytics 或 自建

## 备份策略

| 类型 | 频率 | 保留 |
|---|---|---|
| 全量备份 | 每日 | 30天 |
| WAL归档 | 持续 | 7天 |
| 配置备份 | 每次变更 | Git |
