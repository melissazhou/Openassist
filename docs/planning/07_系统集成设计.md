# 07 系统集成设计

## 集成架构

```
SharePoint ──(抓取)──→ OpenAssist ──(审批通过)──→ 目标系统
  (数据源)              (中枢)                    
                          │
                ┌─────────┼─────────┐
                ▼         ▼         ▼
           Oracle EBS  IWMS WMS    MES
           (Item/BOM)  (映射表)  (工艺参数)
```

## 连接器设计

### 入站连接器 (数据摄入)

| 连接器 | 来源 | 方式 | 频率 |
|---|---|---|---|
| SharePoint Scraper | SharePoint MDM List | Browser Relay抓取 | 10分钟 |
| Email Parser | 邮件请求 | IMAP监听(未来) | 实时 |
| API Ingest | 外部系统推送 | REST API | 实时 |
| Excel Import | 人工上传 | 文件解析 | 按需 |

### 出站连接器 (变更同步)

| 连接器 | 目标 | 方式 | 说明 |
|---|---|---|---|
| EBS Connector | Oracle EBS | PL/SQL API / Interface Table | Item/BOM/Routing变更 |
| WMS Connector | IWMS WMS | 直接SQL / CustomSQL | 映射表/状态更新 |
| MES Connector | MES系统 | API调用(未来) | 工艺参数同步 |

### 连接器接口

```typescript
// src/services/integration/connector.ts

interface Connector {
  name: string;
  
  // 测试连接
  testConnection(): Promise<{ ok: boolean; message: string }>;
  
  // 执行同步
  sync(changeRequest: ChangeRequest): Promise<SyncResult>;
  
  // 查询目标系统数据 (验证用)
  query(entityType: string, entityCode: string): Promise<any>;
}

interface SyncResult {
  status: 'SUCCESS' | 'FAILED' | 'PARTIAL';
  syncedItems: number;
  failedItems: number;
  errors: SyncError[];
  executedSql?: string;         // 审计用
}
```

## EBS集成细节

### Item Master 变更
```sql
-- 通过Interface Table
INSERT INTO mtl_system_items_interface (...)
VALUES (...);
-- 然后触发 Import程序
```

### 通过API (推荐)
```
-- EBS REST API (R12.2+)
PUT /fndAppsCoreApi/resources/items/{itemId}
```

## 同步策略

1. **审批通过** → 自动创建同步任务 (BullMQ队列)
2. **任务执行** → 连接器执行变更 → 记录SyncLog
3. **失败重试** → 最多3次, 指数退避
4. **人工介入** → 3次失败后标记为需人工处理
5. **验证确认** → 同步后查询目标系统验证结果

## 安全

- 数据库密码加密存储 (AES-256)
- 只读连接用于查询验证
- 写入操作需单独配置+审批
- 所有同步操作记录审计日志
